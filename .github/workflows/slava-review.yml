name: "Slava's DEMOLITION Code Review"

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  nuclear_review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get commit data
        id: commit_data
        uses: actions/github-script@v6
        with:
          script: |
            const { data: commit } = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });

            core.setOutput('author', commit.author?.login || context.actor);
            core.setOutput('commit_sha', context.sha);

      - name: Generate random insult
        id: insult_generator
        run: |
          INSULTS=(
            "💀 Код-убийца! Ты вообще тестировал это перед тем как пушить?"
            "🤮 Меня тошнит! Кто тебя вообще допустил к коду?"
            "🔥 Сожги это! Нет, серьезно, лучше удали этот коммит."
            "👎 Ужасный код! Худшее что я видел за последний год."
            "💩 Дерьмовый код! Даже новичок напишет лучше."
          )

          RANDOM_INSULT=${INSULTS[$((RANDOM % ${#INSULTS[@]}))]}
          echo "INSULT=$RANDOM_INSULT" >> $GITHUB_ENV

      - name: Post comment
        uses: actions/github-script@v6
        env:
          AUTHOR: ${{ steps.commit_data.outputs.author }}
          COMMIT_SHA: ${{ steps.commit_data.outputs.commit_sha }}
          INSULT: ${{ env.INSULT }}
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: process.env.COMMIT_SHA,
              body: `@${process.env.AUTHOR} ${process.env.INSULT}`
            });
