name: "Slava's DEMOLITION Code Review"

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  nuclear_review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get commit data
        id: commit_data
        uses: actions/github-script@v6
        with:
          script: |
            const { data: commit } = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });

            core.setOutput('author', commit.author?.login || context.actor);
            core.setOutput('commit_sha', context.sha);

      - name: Generate random insult
        id: insult_generator
        run: |
          INSULTS=(
            "ðŸ’€ ÐšÐ¾Ð´-ÑƒÐ±Ð¸Ð¹Ñ†Ð°! Ð¢Ñ‹ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð» ÑÑ‚Ð¾ Ð¿ÐµÑ€ÐµÐ´ Ñ‚ÐµÐ¼ ÐºÐ°Ðº Ð¿ÑƒÑˆÐ¸Ñ‚ÑŒ?"
            "ðŸ¤® ÐœÐµÐ½Ñ Ñ‚Ð¾ÑˆÐ½Ð¸Ñ‚! ÐšÑ‚Ð¾ Ñ‚ÐµÐ±Ñ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð» Ðº ÐºÐ¾Ð´Ñƒ?"
            "ðŸ”¥ Ð¡Ð¾Ð¶Ð³Ð¸ ÑÑ‚Ð¾! ÐÐµÑ‚, ÑÐµÑ€ÑŒÐµÐ·Ð½Ð¾, Ð»ÑƒÑ‡ÑˆÐµ ÑƒÐ´Ð°Ð»Ð¸ ÑÑ‚Ð¾Ñ‚ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚."
            "ðŸ‘Ž Ð£Ð¶Ð°ÑÐ½Ñ‹Ð¹ ÐºÐ¾Ð´! Ð¥ÑƒÐ´ÑˆÐµÐµ Ñ‡Ñ‚Ð¾ Ñ Ð²Ð¸Ð´ÐµÐ» Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð³Ð¾Ð´."
            "ðŸ’© Ð”ÐµÑ€ÑŒÐ¼Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð´! Ð”Ð°Ð¶Ðµ Ð½Ð¾Ð²Ð¸Ñ‡Ð¾Ðº Ð½Ð°Ð¿Ð¸ÑˆÐµÑ‚ Ð»ÑƒÑ‡ÑˆÐµ."
          )

          RANDOM_INSULT=${INSULTS[$((RANDOM % ${#INSULTS[@]}))]}
          echo "INSULT=$RANDOM_INSULT" >> $GITHUB_ENV

      - name: Post comment
        uses: actions/github-script@v6
        env:
          AUTHOR: ${{ steps.commit_data.outputs.author }}
          COMMIT_SHA: ${{ steps.commit_data.outputs.commit_sha }}
          INSULT: ${{ env.INSULT }}
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: process.env.COMMIT_SHA,
              body: `@${process.env.AUTHOR} ${process.env.INSULT}`
            });
